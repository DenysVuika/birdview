<!DOCTYPE html>
<html lang="en">
<head>
    <title>BirdView</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // <birdview:DATA>
    </script>
    <script type="module">
        import { h, render, Component } from 'https://esm.sh/preact';
        import htm from 'https://esm.sh/htm';
        // import { useState, useCallback } from 'https://esm.sh/preact/hooks';

        const html = htm.bind(h);

        function Header({ data }) {
            return html`
                <section class="hero is-primary">
                    <div class="hero-body">
                        <p class="title">
                            ${data.project.name} ${data.project.version}
                        </p>
                        <p class="subtitle">${data.report_date}</p>
                    </div>
                </section>
            `;
        }

        function LinkRow({ caption, url, standalone }) {
            return html`
                <a class="panel-block">
                    ${url
                        ? html`<a href="${url}" target="_blank">${caption}</a>`
                        : html`<span>${caption}</span>`
                    }
                    ${standalone && html`<span class="tag is-success ml-2">standalone</span>`}
                </a>
            `;
        }

        function DependencyRow({ entry }) {
            return html`
                <div class="panel-block" style="align-items: baseline">
                    <a class="tags has-addons mb-0" href="${entry.npm_url}" target="_blank">
                      <span class="tag is-dark mb-0">${entry.name}</span>
                      <span class="tag is-info mb-0">${entry.version}</span>
                    </a>
                    <span class="pl-4">
                        ${entry.pkg_url
                            ? html`<a href="${entry.pkg_url}" target="_blank">${entry.pkg}</a>`
                            : html`<span>${entry.pkg}</span>`
                        }
                    </span>
                </div>
            `;
        }

        class ReportPanel extends Component {
            state = {
                activeTab: 0
            };

            setActiveTab(index) {
                this.setState({ activeTab: index });
            }
        }

        class Packages extends ReportPanel {
            state = {
                activeTab: 0,
                warnings: [],
                packages: [],
                dependencies: [],
                devDependencies: []
            };

            componentDidMount() {
                const data = this.props.data;
                const git = data.git;
                const warnings = (data.warnings || [])
                    .filter(warning => warning.module === 'packages')
                    .map(entry => ({
                        ...entry,
                        url: !!git ? `${git.remote}/blob/${git.target}/${entry.path}`: ''
                    }));
                const packages = this.getPackages(data);
                const dependencies = this.getDependencies(data, false);
                const devDependencies = this.getDependencies(data, true);

                this.setState({ warnings, packages, dependencies, devDependencies });
            }

            getPackages(data) {
                const packages = data.packages || [];
                const git = data.git;

                return packages.map(entry => ({
                    path: entry.path,
                    url: !!git ? `${git.remote}/blob/${git.target}/${entry.path}`: ''
                }));
            }

            getDependencies(data, dev) {
                const git = data.git;
                const result = [];

                for (const pkg of data.packages) {
                    if (pkg.dependencies) {
                        for (const dep of pkg.dependencies.filter(dep => dep.dev === dev)) {
                            result.push({
                                name: dep.name,
                                version: dep.version,
                                pkg: pkg.path,
                                pkg_url: !!git ? `${git.remote}/blob/${git.target}/${pkg.path}`: '',
                                npm_url: `https://www.npmjs.com/package/${dep.name}`
                            })
                        }
                    }
                }
                return result.sort((a, b) => a.name.localeCompare(b.name));
            }

            render({ data }, { activeTab, warnings, packages, dependencies, devDependencies }) {
                const TabHeader = ({ index, title }) => html`
                    <a class="${ activeTab === index ? 'is-active' : null}" onClick="${() => this.setActiveTab(index)}">${title}</a>
                `;

                return html`
                    <nav class="panel is-link">
                        <p class="panel-heading">Packages (${packages.length})</p>

                        <p class="panel-tabs">
                            <${TabHeader} index=${0} title="Stats"/>
                            ${warnings.length > 0 && html`
                                <${TabHeader} index=${4} title="Warnings (${warnings.length})"/>
                            `}
                            <${TabHeader} index=${1} title="Packages (${packages.length})" />
                            <${TabHeader} index=${2} title="Prod Deps (${dependencies.length})" />
                            <${TabHeader} index=${3} title="Dev Deps (${devDependencies.length})" />
                        </p>

                        <div style="max-height: 500px; overflow-y: scroll">
                            ${activeTab === 0 && html`
                                <${LinkRow} caption="Packages: ${packages.length}"/>
                                <${LinkRow} caption="Product dependencies: ${dependencies.length}"/>
                                <${LinkRow} caption="Development dependencies: ${devDependencies.length}"/>
                            `}

                            ${activeTab === 1 && html`
                                ${packages.map(entry => html`
                                    <${LinkRow} caption="${entry.path}" url="${entry.url}"></LinkRow>
                                `)}
                            `}

                            ${activeTab === 2 && html`
                                ${dependencies.map(entry => html`
                                    <${DependencyRow} entry="${entry}" />
                                `)}
                            `}

                             ${activeTab === 3 && html`
                                ${devDependencies.map(entry => html`
                                    <${DependencyRow} entry="${entry}" />
                                `)}
                            `}

                             ${activeTab === 4 && html`
                                ${warnings.map(entry => html`
                                    <a class="panel-block">
                                        <nav class="breadcrumb">
                                            <ul>
                                                <li>
                                                    ${entry.url
                                                        ? html`<a href="${entry.url}" target="_blank">${entry.path}</a>`
                                                        : html`<span>${entry.path}</span>`
                                                    }
                                                </li>
                                                <li class="is-active">
                                                    <a class="has-text-danger" href="#">${entry.message}</a>
                                                </li>
                                            </ul>
                                        </nav>
                                    </a>
                                `)}
                            `}
                         </div>
                    </nav>
                `;
            }
        }

        class Tests extends ReportPanel {
            state = {
                activeTab: 0,
                unitTests: [],
                e2eTests: [],
                totalCases: 0
            };

            setActiveTab(index) {
                super.setActiveTab(index);

                if (index === 0) {
                    setTimeout(() => {
                        this.setupChart();
                    });
                }
            }

            componentDidMount() {
                const data = this.props.data;
                const unitTests = this.getEntries(data, 'unit_tests');
                const e2eTests = this.getEntries(data, 'e2e_tests');

                const tests = data.stats.tests;
                const totalCases = tests.unit_test_case + tests.e2e_test_case;

                this.setState({
                    unitTests,
                    e2eTests,
                    totalCases
                });
            }

            getEntries(data, key) {
                const tests = data[key] || [];
                const git = data.git;

                return tests.map(entry => ({
                    path: entry.path,
                    cases: entry.cases.length,
                    url: !!git ? `${git.remote}/blob/${git.target}/${entry.path}`: ''
                }));
            }

            setupChart() {
                const ctx = document.getElementById('tests-chart');
                const tests = window.data.stats.tests;

                const existing = Chart.getChart('tests-chart');
                if (existing) {
                    existing.destroy();
                }

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Unit Cases', 'E2E Cases'],
                        datasets: [{
                            label: '# of cases',
                            data: [
                                tests.unit_test_case,
                                tests.e2e_test_case,
                            ],
                            backgroundColor: [
                                'rgb(255, 99, 132)',
                                'rgb(54, 162, 235)'
                            ],
                            hoverOffset: 4
                        }]
                    }
                });
            }

            render({ data }, { activeTab, totalCases, unitTests, e2eTests }) {
                setTimeout(() => {
                    if (activeTab === 0) {
                        this.setupChart();
                    }
                });

                const TabHeader = ({ index, title }) => html`
                    <a class="${ activeTab === index ? 'is-active' : null}" onClick="${() => this.setActiveTab(index)}">${title}</a>
                `;

                return html`
                    <nav class="panel is-link">
                        <p class="panel-heading">Tests (${totalCases})</p>

                        <p class="panel-tabs">
                            <${TabHeader} index=${0} title="Stats" />
                            ${unitTests.length > 0 && html`<${TabHeader} index=${1} title="Unit Tests (${unitTests.length})" />`}
                            ${e2eTests.length > 0 && html`<${TabHeader} index=${2} title="E2E Tests (${e2eTests.length})" />`}
                        </p>

                        <div style="max-height: 500px; overflow-y: scroll">
                            ${activeTab === 0 && html`
                                <div style="max-height: 400px; padding: 12px">
                                  <canvas id="tests-chart"></canvas>
                                </div>
                            `}

                            ${activeTab === 1 && html`
                                ${unitTests.map(entry => html`
                                    <${LinkRow} caption="${entry.path} (${entry.cases} cases)" url="${entry.url}"></LinkRow>
                                `)}
                            `}

                            ${activeTab === 2 && html`
                                ${e2eTests.map(entry => html`
                                    <${LinkRow} caption="${entry.path} (${entry.cases} cases)" url="${entry.url}"></LinkRow>
                                `)}
                            `}
                        </div>
                    </nav>
                `;
            }
        }

        class Angular extends ReportPanel {
            state = {
                activeTab: 0,
                modules: [],
                components: [],
                directives: [],
                services: [],
                pipes: [],
                dialogs: []
            };
            setActiveTab(index) {
                super.setActiveTab(index);

                if (index === 0) {
                    setTimeout(() => { this.setupChart();});
                }
            }

            componentDidMount() {
                const data = this.props.data;
                const modules = this.getEntities(data, 'modules');
                const components = this.getEntities(data, 'components');
                const directives = this.getEntities(data, 'directives');
                const services = this.getEntities(data, 'services');
                const pipes = this.getEntities(data, 'pipes');
                const dialogs = this.getEntities(data, 'dialogs');
                this.setState({ modules, components, directives, services, pipes, dialogs });
            }

            setupChart() {
                const ctx = document.getElementById('angular-chart');
                const angular = window.data.angular;

                const existing = Chart.getChart('angular-chart');
                if (existing) {
                    existing.destroy();
                }

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Module', 'Component', 'Directive', 'Service', 'Pipe', 'Dialog'],
                        datasets: [{
                            label: '# of elements',
                            data: [
                                angular.modules.length,
                                angular.components.length,
                                angular.directives.length,
                                angular.services.length,
                                angular.pipes.length,
                                angular.dialogs.length
                            ],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(255, 159, 64, 0.2)',
                                // 'rgba(255, 205, 86, 0.2)',
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(153, 102, 255, 0.2)',
                                'rgba(201, 203, 207, 0.2)'
                            ],
                            borderColor: [
                                'rgb(255, 99, 132)',
                                'rgb(255, 159, 64)',
                                // 'rgb(255, 205, 86)',
                                'rgb(75, 192, 192)',
                                'rgb(54, 162, 235)',
                                'rgb(153, 102, 255)',
                                'rgb(201, 203, 207)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            getEntities(data, key) {
                const entities = data.angular[key] || [];
                const git = data.git;

                return entities.map(entry => ({
                    ...entry,
                    url: !!git ? `${git.remote}/blob/${git.target}/${entry.path}` : ''
                }));
            }

            render({ data }, { activeTab, modules, components, directives, services, pipes, dialogs }) {
                setTimeout(() => {
                    if (activeTab === 0) {
                        this.setupChart();
                    }
                });
                const TabHeader = ({ index, title }) => html`
                    <a class="${ activeTab === index ? 'is-active' : null}" onClick="${() => this.setActiveTab(index)}">${title}</a>
                `;

                const ngVersion = data.angular_version;

                return html`
                    <nav class="panel is-link">
                        <p class="panel-heading">Angular (${ngVersion})</p>

                        <p class="panel-tabs">
                            <${TabHeader} index=${0} title="Stats" />

                            ${modules.length > 0 && html`<${TabHeader} index=${1} title="Modules (${modules.length})" />`}
                            ${components.length > 0 && html`<${TabHeader} index=${2} title="Components (${components.length})" />`}
                            ${directives.length > 0 && html`<${TabHeader} index=${3} title="Directives (${directives.length})" />`}
                            ${services.length > 0 && html`<${TabHeader} index=${4} title="Services (${services.length})" />`}
                            ${pipes.length > 0 && html`<${TabHeader} index=${5} title="Pipes (${pipes.length})" />`}
                            ${dialogs.length > 0 && html`<${TabHeader} index=${6} title="Dialogs (${dialogs.length})" />`}
                        </p>

                        <div style="max-height: 500px; overflow-y: scroll">
                            ${activeTab === 0 && html`
                                <div style="max-height: 400px; padding: 12px">
                                  <canvas id="angular-chart"></canvas>
                                </div>
                            `}

                            ${activeTab === 1 && html`
                                ${modules.map(entry => html`
                                    <${LinkRow} caption="${entry.path}" url="${entry.url}"/>
                                `)}
                            `}

                            ${activeTab === 2 && html`
                                ${components.map(entry => html`
                                    <${LinkRow} caption="${entry.path}" url="${entry.url}" standalone="${entry.standalone}"/>
                                `)}
                            `}

                            ${activeTab === 3 && html`
                                ${directives.map(entry => html`
                                    <${LinkRow} caption="${entry.path}" url="${entry.url}" standalone="${entry.standalone}"/>
                                `)}
                            `}

                            ${activeTab === 4 && html`
                                ${services.map(entry => html`
                                    <${LinkRow} caption="${entry.path}" url="${entry.url}"/>
                                `)}
                            `}

                            ${activeTab === 5 && html`
                                ${pipes.map(entry => html`
                                    <${LinkRow} caption="${entry.path}" url="${entry.url}" standalone="${entry.standalone}"/>
                                `)}
                            `}

                            ${activeTab === 6 && html`
                                ${dialogs.map(entry => html`
                                    <${LinkRow} caption="${entry.path}" url="${entry.url}" standalone="${entry.standalone}"/>
                                `)}
                            `}
                        </div>
                    </nav>
                `;
            }
        }

        class GitReport extends ReportPanel {
            setActiveTab(index) {
                super.setActiveTab(index);

                if (index === 1) {
                    setTimeout(() => {
                        this.setupChart();
                    });
                }
            }

            setupChart() {
                const ctx = document.getElementById('git-top-contributors');
                const git = this.props.data;

                const existing = Chart.getChart('git-top-contributors');
                if (existing) {
                    existing.destroy();
                }

                const authors = git.authors.slice(0, 20);
                const chart_labels = authors.map(entry => entry.name);
                const chart_data = authors.map(entry => entry.commits);

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chart_labels,
                        datasets: [{
                            label: '# of commits',
                            data: chart_data,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            render({ data }, { activeTab }) {
                setTimeout(() => {
                    if (activeTab === 1) {
                        this.setupChart();
                    }
                });

                const TabHeader = ({ index, title }) => html`
                    <a class="${ activeTab === index ? 'is-active' : null}" onClick="${() => this.setActiveTab(index)}">${title}</a>
                `;

                return html`
                    <nav class="panel is-link">
                        <p class="panel-heading">Git</p>

                        <p class="panel-tabs">
                            <${TabHeader} index=${0} title="Stats" />
                            <${TabHeader} index=${1} title="Top Contributors" />
                            <${TabHeader} index=${2} title="All Authors" />
                        </p>

                        <div style="max-height: 500px; overflow-y: scroll">
                            ${activeTab === 0 && html`
                                <${LinkRow} caption="Remote: ${data.remote}" url="${data.remote}"/>
                                <${LinkRow} caption="Branch: ${data.branch}"/>
                                <${LinkRow} caption="Head: ${data.target}"/>
                            `}
                            ${activeTab === 1 && html`
                                <div style="max-height: 400px; padding: 12px">
                                  <canvas id="git-top-contributors"></canvas>
                                </div>
                            `}
                            ${activeTab === 2 && html`
                                ${data.authors.map(author => html`
                                    <${LinkRow} caption="${author.name} (${author.commits} commits)"/>
                                `)}
                            `}
                        </div>
                    </nav>
                `;
            }
        }

        function FileTypes({ data }) {
            const rows = Object.keys(data)
                .map(key => ({ key, value: data[key] }))
                .sort((a, b) => b.value - a.value);

            return html`
                <nav class="panel is-link">
                    <p class="panel-heading">Files</p>

                    <div style="max-height: 500px; overflow-y: scroll">
                        ${rows.map(row => html`
                            <${LinkRow} caption="${row.key}: ${row.value}"/>
                        `)}
                    </div>
                </nav>
            `;
        }

        function App({ data }) {
            const hasModule = (moduleName) => data.project.modules.includes(moduleName);
            const hasGit = !!data.git;

            return html`
                <main>
                    <${Header} data=${data}></Header>
                    <section class="section">
                        ${hasGit && html`<${GitReport} data=${data.git}/>`}
                        ${hasModule('packages') && html`<${Packages} data=${data}/>`}
                        ${hasModule('angular-entities') && html`<${Angular} data=${data}/>`}
                        ${hasModule('angular-tests') && html`<${Tests} data=${data}/>`}
                        ${hasModule('file-types') && html`<${FileTypes} data=${data.stats.types}></FileTypes>`}
                    </section>
                </main>
            `;
        }

        render(html`
            <${App} data=${window.data}/>`, document.body);
    </script>
    <script>
        window.addEventListener("DOMContentLoaded", (event) => {
            // on load handlers
        });
    </script>
</head>
<body></body>
</html>
