<!DOCTYPE html>
<html lang="en">
<head>
    <title>BirdView</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css"/>
    <script>
        // <birdview:DATA>
    </script>
    <script type="module">
        import {h, render, Component} from 'https://esm.sh/preact';
        import htm from 'https://esm.sh/htm';

        const html = htm.bind(h);

        function Header({ data }) {
            return html`
                <section class="hero is-primary">
                    <div class="hero-body">
                        <p class="title">
                            ${data.project.name} ${data.project.version}
                        </p>
                        <p class="subtitle">${data.report_date}</p>
                    </div>
                </section>
            `;
        }

        function PanelRow({ icon, label }) {
            return html`
                <a class="panel-block">
                    <span class="panel-icon">
                        <i class="mdi ${icon}"></i>
                    </span>
                    <span>${label}</span>
                </a>
            `;
        }

        function LinkRow({ caption, url, icon }) {
            return html`
                <a class="panel-block">
                    <span class="panel-icon">
                        <i class="mdi ${icon}"></i>
                    </span>
                    <a href="${url}" target="_blank">${caption}</a>
                </a>
            `;
        }

        class ReportPanel extends Component {
            state = {
                activeTab: 0
            };

            setActiveTab(index) {
                this.setState({ activeTab: index });
            }
        }

        class Packages extends ReportPanel {
            getPackages(data) {
                const packages = data.packages;
                const git = data.project.git;

                return packages.map(entry => ({
                    path: entry.path,
                    url: `${git.remote}/blob/${git.target}/${entry.path}`
                }));
            }

            getDependencies(dev) {
                const result = [];
                for (const pkg of data.packages) {
                    if (pkg.dependencies) {
                        for (const dep of pkg.dependencies.filter(dep => dep.dev === dev)) {
                            const name = `${dep.name}@${dep.version}`;
                            result.push({
                                name,
                                pkg: pkg.path,
                                npm_url: `https://www.npmjs.com/package/${dep.name}`
                            })
                        }
                    }
                }
                return result;
            }

            render(props, { activeTab }) {
                const data = props.data;
                const pkg = data.stats.package;

                return html`
                    <nav class="panel is-link">
                        <p class="panel-heading">Packages</p>

                        <p class="panel-tabs">
                            <a class="${ activeTab === 0 ? 'is-active' : null}" onClick="${() => this.setActiveTab(0)}">Stats</a>
                            <a class="${ activeTab === 1 ? 'is-active' : null}" onClick="${() => this.setActiveTab(1)}">Packages</a>
                            <a class="${ activeTab === 2 ? 'is-active' : null}" onClick="${() => this.setActiveTab(2)}">Prod Deps</a>
                            <a class="${ activeTab === 3 ? 'is-active' : null}" onClick="${() => this.setActiveTab(3)}">Dev Deps</a>
                          </p>

                        ${activeTab === 0 && html`
                            <${PanelRow} icon="mdi-package-variant-closed" label="Packages: ${pkg.files}"/>
                            <${PanelRow} icon="mdi-package-variant-closed" label="Product dependencies: ${pkg.prod_deps}"/>
                            <${PanelRow} icon="mdi-package-variant-closed" label="Development dependencies: ${pkg.dev_deps}"/>
                        `}

                        ${activeTab === 1 && html`
                            ${this.getPackages(data).map(entry => html`
                                <${LinkRow} caption="${entry.path}" url="${entry.url}" icon="mdi-code-json"></LinkRow>
                            `)}
                        `}

                        ${activeTab === 2 && html`
                            ${this.getDependencies(false).map(entry => html`
                                <${LinkRow} caption="${entry.name} (${entry.pkg})" url="${entry.npm_url}" icon="mdi-package-variant-closed"></LinkRow>
                            `)}
                        `}

                         ${activeTab === 3 && html`
                            ${this.getDependencies(true).map(entry => html`
                                <${LinkRow} caption="${entry.name} (${entry.pkg})" url="${entry.npm_url}" icon="mdi-package-variant-closed"></LinkRow>
                            `)}
                        `}
                    </nav>
                `;
            }
        }

        function Tests({ data }) {
            return html`
                <nav class="panel is-link">
                    <p class="panel-heading">Tests</p>

                    <${PanelRow} icon="mdi-test-tube" label="Unit tests: ${data.unit_test_case} (${data.unit_test} files)"/>
                    <${PanelRow} icon="mdi-test-tube" label="E2E tests: ${data.e2e_test_case} (${data.e2e_test} files)"/>
                </nav>
            `;
        }

        class Angular extends ReportPanel {
            getModules(data) {
                const modules = data.angular.modules;
                const git = data.project.git;

                return modules.map(path => ({
                    path,
                    url: `${git.remote}/blob/${git.target}/${path}`
                }));
            }

            getComponents(data) {
                const components = data.angular.components;
                const git = data.project.git;

                return components.map(entry => ({
                    path: entry.path,
                    standalone: entry.standalone,
                    url: `${git.remote}/blob/${git.target}/${entry.path}`
                }));
            }

            getDirectives(data) {
                const directives = data.angular.directives;
                const git = data.project.git;

                return directives.map(path => ({
                    path,
                    url: `${git.remote}/blob/${git.target}/${path}`
                }));
            }

            getServices(data) {
                const services = data.angular.services;
                const git = data.project.git;

                return services.map(path => ({
                    path,
                    url: `${git.remote}/blob/${git.target}/${path}`
                }));
            }

            getPipes(data) {
                const pipes = data.angular.pipes;
                const git = data.project.git;

                return pipes.map(path => ({
                    path,
                    url: `${git.remote}/blob/${git.target}/${path}`
                }));
            }

            getDialogs(data) {
                const dialogs = data.angular.dialogs;
                const git = data.project.git;

                return dialogs.map(path => ({
                    path,
                    url: `${git.remote}/blob/${git.target}/${path}`
                }));
            }

            render(props, { activeTab }) {
                const data = props.data;
                const angular = data.stats.angular;
                const ngVersion = data.angular.framework;

                return html`
                    <nav class="panel is-link">
                        <p class="panel-heading">Angular</p>

                        <p class="panel-tabs">
                            <a class="${ activeTab === 0 ? 'is-active' : null}" onClick="${() => this.setActiveTab(0)}">Stats</a>
                            <a class="${ activeTab === 1 ? 'is-active' : null}" onClick="${() => this.setActiveTab(1)}">Modules</a>
                            <a class="${ activeTab === 2 ? 'is-active' : null}" onClick="${() => this.setActiveTab(2)}">Components</a>
                            <a class="${ activeTab === 3 ? 'is-active' : null}" onClick="${() => this.setActiveTab(3)}">Directives</a>
                            <a class="${ activeTab === 4 ? 'is-active' : null}" onClick="${() => this.setActiveTab(4)}">Services</a>
                            <a class="${ activeTab === 5 ? 'is-active' : null}" onClick="${() => this.setActiveTab(5)}">Pipes</a>
                            <a class="${ activeTab === 6 ? 'is-active' : null}" onClick="${() => this.setActiveTab(6)}">Dialogs</a>
                        </p>

                        ${activeTab === 0 && html`
                            <${PanelRow} icon="mdi-file-code-outline" label="Angular: ${ngVersion}"/>
                            <${PanelRow} icon="mdi-file-code-outline" label="Modules: ${angular.module}"/>
                            <${PanelRow} icon="mdi-file-code-outline" label="Components: ${angular.component}"/>
                            <${PanelRow} icon="mdi-file-code-outline" label="Components (standalone): ${angular.component_standalone}"/>
                            <${PanelRow} icon="mdi-file-code-outline" label="Directives: ${angular.directive}"/>
                            <${PanelRow} icon="mdi-file-code-outline" label="Services: ${angular.service}"/>
                            <${PanelRow} icon="mdi-file-code-outline" label="Pipes: ${angular.pipe}"/>
                            <${PanelRow} icon="mdi-file-code-outline" label="Dialogs: ${angular.dialog}"/>
                        `}

                        ${activeTab === 1 && html`
                            ${this.getModules(data).map(entry => html`
                                <${LinkRow} caption="${entry.path}" url="${entry.url}" icon="mdi-file-code-outline"></LinkRow>
                            `)}
                        `}

                        ${activeTab === 2 && html`
                            ${this.getComponents(data).map(entry => html`
                                <${LinkRow} caption="${entry.path} (standalone: ${entry.standalone})" url="${entry.url}" icon="mdi-file-code-outline"></LinkRow>
                            `)}
                        `}

                        ${activeTab === 3 && html`
                            ${this.getDirectives(data).map(entry => html`
                                <${LinkRow} caption="${entry.path}" url="${entry.url}" icon="mdi-file-code-outline"></LinkRow>
                            `)}
                        `}

                        ${activeTab === 4 && html`
                            ${this.getServices(data).map(entry => html`
                                <${LinkRow} caption="${entry.path}" url="${entry.url}" icon="mdi-file-code-outline"></LinkRow>
                            `)}
                        `}

                        ${activeTab === 5 && html`
                            ${this.getPipes(data).map(entry => html`
                                <${LinkRow} caption="${entry.path}" url="${entry.url}" icon="mdi-file-code-outline"></LinkRow>
                            `)}
                        `}

                        ${activeTab === 6 && html`
                            ${this.getDialogs(data).map(entry => html`
                                <${LinkRow} caption="${entry.path}" url="${entry.url}" icon="mdi-file-code-outline"></LinkRow>
                            `)}
                        `}
                    </nav>
                `;
            }
        }

        function FileTypes({ data }) {
            const rows = Object.keys(data).map(key => ({ key, value: data[key] }));

            return html`
                <nav class="panel is-link">
                    <p class="panel-heading">Files</p>

                    ${rows.map(row => html`
                        <${PanelRow} icon="mdi-file-document" label="${row.key}: ${row.value}"/>
                    `)}
                </nav>
            `;
        }

        function App({ data }) {
            return html`
                <main>
                    <${Header} data=${data}></Header>
                    <section class="section">
                        <${Packages} data=${data}></Packages>
                        <${Angular} data=${data}></Angular>
                        <${Tests} data=${data.stats.tests}></Tests>
                        <${FileTypes} data=${data.stats.types}></FileTypes>
                    </section>
                </main>
            `;
        }

        render(html`
            <${App} data=${window.data}/>`, document.body);
    </script>
</head>
<body></body>
</html>
