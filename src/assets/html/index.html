<!DOCTYPE html>
<html lang="en">
<head>
    <title>BirdView</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css"/>
    <script>
        // <birdview:DATA>
    </script>
    <script type="module">
        import {h, render, Component} from 'https://esm.sh/preact';
        import htm from 'https://esm.sh/htm';

        const html = htm.bind(h);

        function Header(props) {
            const data = props.data;
            return html`
                <section class="hero is-primary">
                    <div class="hero-body">
                        <p class="title">
                            ${data.project.name} ${data.project.version}
                        </p>
                        <p class="subtitle">${data.report_date}</p>
                    </div>
                </section>
            `;
        }

        function PanelRow(props) {
            return html`
                <a class="panel-block">
                    <span class="panel-icon">
                        <i class="mdi ${props.icon}"></i>
                    </span>
                    <span>${props.label}</span>
                </a>
            `;
        }

        class Packages extends Component {
            state = {
                activeTab: 0
            };

            setActiveTab(index) {
                this.setState({ activeTab: index });
            }

            getDependencies(dev) {
                const result = [];
                for (const pkg of data.packages) {
                    if (pkg.dependencies) {
                        for (const dep of pkg.dependencies.filter(dep => dep.dev === dev)) {
                            const name = `${dep.name}@${dep.version}`;
                            if (!result.includes(dep.name)) {
                                result.push(name);
                            }
                        }
                    }
                }
                return result;
            }

            render(props, { activeTab }) {
                const data = props.data;
                const pkg = data.stats.package;

                return html`
                    <nav class="panel is-link">
                        <p class="panel-heading">Packages</p>

                        <p class="panel-tabs">
                            <a class="${ activeTab === 0 ? 'is-active' : null}" onClick="${() => this.setActiveTab(0)}">Stats</a>
                            <a class="${ activeTab === 1 ? 'is-active' : null}" onClick="${() => this.setActiveTab(1)}">Packages</a>
                            <a class="${ activeTab === 2 ? 'is-active' : null}" onClick="${() => this.setActiveTab(2)}">Prod Deps</a>
                            <a class="${ activeTab === 3 ? 'is-active' : null}" onClick="${() => this.setActiveTab(3)}">Dev Deps</a>
                          </p>

                        ${activeTab === 0 && html`
                            <${PanelRow} icon="mdi-package-variant-closed" label="Packages: ${pkg.files}"/>
                            <${PanelRow} icon="mdi-package-variant-closed" label="Product dependencies: ${pkg.prod_deps}"/>
                            <${PanelRow} icon="mdi-package-variant-closed" label="Development dependencies: ${pkg.dev_deps}"/>
                        `}

                        ${activeTab === 1 && html`
                            ${data.packages.map(pkg => html`
                                <${PanelRow} icon="mdi-code-json" label="${pkg.path}"/>
                            `)}
                        `}

                        ${activeTab === 2 && html`
                            ${this.getDependencies(false).map(name => html`
                                <${PanelRow} icon="mdi-package-variant-closed" label="${name}"/>
                            `)}
                        `}

                         ${activeTab === 3 && html`
                            ${this.getDependencies(true).map(name => html`
                                <${PanelRow} icon="mdi-package-variant-closed" label="${name}"/>
                            `)}
                        `}
                    </nav>
                `;
            }
        }

        function Tests(props) {
            const data = props.data;
            const tests = data.stats.tests;

            return html`
                <nav class="panel is-link">
                    <p class="panel-heading">Tests</p>

                    <${PanelRow} icon="mdi-test-tube" label="Unit tests: ${tests.unit_test_case} (${tests.unit_test} files)"/>
                    <${PanelRow} icon="mdi-test-tube" label="E2E tests: ${tests.e2e_test_case} (${tests.e2e_test} files)"/>
                </nav>
            `;
        }

        class Angular extends Component {
            state = {
                activeTab: 0
            };

            setActiveTab(index) {
                this.setState({ activeTab: index });
            }

            getModules(data) {
                const modules = data.angular.modules;
                const git = data.project.git;

                return modules.map(path => ({
                    path,
                    url: `${git.remote}/blob/${git.target}/${path}`
                }));
            }

            render(props, { activeTab }) {
                const data = props.data;
                const angular = data.stats.angular;
                const ngVersion = data.angular.framework;

                return html`
                    <nav class="panel is-link">
                        <p class="panel-heading">Angular</p>

                        <p class="panel-tabs">
                            <a class="${ activeTab === 0 ? 'is-active' : null}" onClick="${() => this.setActiveTab(0)}">Stats</a>
                            <a class="${ activeTab === 1 ? 'is-active' : null}" onClick="${() => this.setActiveTab(1)}">Modules</a>
                            <a class="${ activeTab === 2 ? 'is-active' : null}" onClick="${() => this.setActiveTab(2)}">Components</a>
                            <a class="${ activeTab === 3 ? 'is-active' : null}" onClick="${() => this.setActiveTab(3)}">Directives</a>
                            <a class="${ activeTab === 4 ? 'is-active' : null}" onClick="${() => this.setActiveTab(4)}">Services</a>
                            <a class="${ activeTab === 5 ? 'is-active' : null}" onClick="${() => this.setActiveTab(5)}">Pipes</a>
                            <a class="${ activeTab === 6 ? 'is-active' : null}" onClick="${() => this.setActiveTab(6)}">Dialogs</a>
                        </p>

                        ${activeTab === 0 && html`
                            <${PanelRow} icon="mdi-file-code-outline" label="Angular: ${ngVersion}"/>
                            <${PanelRow} icon="mdi-file-code-outline" label="Modules: ${angular.module}"/>
                            <${PanelRow} icon="mdi-file-code-outline" label="Components: ${angular.component}"/>
                            <${PanelRow} icon="mdi-file-code-outline" label="Components (standalone): ${angular.component_standalone}"/>
                            <${PanelRow} icon="mdi-file-code-outline" label="Directives: ${angular.directive}"/>
                            <${PanelRow} icon="mdi-file-code-outline" label="Services: ${angular.service}"/>
                            <${PanelRow} icon="mdi-file-code-outline" label="Pipes: ${angular.pipe}"/>
                            <${PanelRow} icon="mdi-file-code-outline" label="Dialogs: ${angular.dialog}"/>
                        `}

                        ${activeTab === 1 && html`
                            ${this.getModules(data).map(entry => html`
                                <a class="panel-block">
                                    <span class="panel-icon">
                                        <i class="mdi mdi-file-code-outline"></i>
                                    </span>
                                    <a href="${entry.url}" target="_blank">${entry.path}</a>
                                </a>
                            `)}
                        `}

                        ${activeTab === 2 && html`
                            ${data.angular.components.map(entry => html`
                                <${PanelRow} icon="mdi-file-code-outline" label="${entry.path} (standalone: ${entry.standalone})"/>
                            `)}
                        `}

                        ${activeTab === 3 && html`
                            ${data.angular.directives.map(name => html`
                                <${PanelRow} icon="mdi-file-code-outline" label="${name}"/>
                            `)}
                        `}

                        ${activeTab === 4 && html`
                            ${data.angular.services.map(name => html`
                                <${PanelRow} icon="mdi-file-code-outline" label="${name}"/>
                            `)}
                        `}

                        ${activeTab === 5 && html`
                            ${data.angular.pipes.map(name => html`
                                <${PanelRow} icon="mdi-file-code-outline" label="${name}"/>
                            `)}
                        `}

                        ${activeTab === 6 && html`
                            ${data.angular.dialogs.map(name => html`
                                <${PanelRow} icon="mdi-file-code-outline" label="${name}"/>
                            `)}
                        `}
                    </nav>
                `;
            }
        }

        function FileTypes(props) {
            const types = props.data.stats.types;
            const rows = Object.keys(types).map(key => ({ key, value: types[key] }));

            return html`
                <nav class="panel is-link">
                    <p class="panel-heading">Files</p>

                    ${rows.map(row => html`
                        <${PanelRow} icon="mdi-file-document" label="${row.key}: ${row.value}"/>
                    `)}
                </nav>
            `;
        }

        function App(props) {
            const data = props.data;

            return html`
                <main>
                    <${Header} data=${data}></Header>
                    <section class="section">
                        <${Packages} data=${data}></Packages>
                        <${Angular} data=${data}></Angular>
                        <${Tests} data=${data}></Tests>
                        <${FileTypes} data=${data}></FileTypes>
                    </section>
                </main>
            `;
        }

        render(html`
            <${App} data=${window.data}/>`, document.body);
    </script>
</head>
<body></body>
</html>
