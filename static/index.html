<!DOCTYPE html>
<html lang="en">
<head>
    <title>BirdView</title>
    <meta charset="UTF-8"/>
    <link rel="icon" href="/favicon.svg" sizes="any" type="image/svg+xml">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // <birdview:DATA>
    </script>
    <script type="module">
        import { h, render, Component } from 'https://esm.sh/preact';
        import htm from 'https://esm.sh/htm';
        // import { useState, useCallback } from 'https://esm.sh/preact/hooks';

        const html = htm.bind(h);

        class Header extends Component {
            state = {
                project: {}
            };

            componentDidMount() {
                const sid = this.props.sid;
                if (sid) {
                    fetch(`/api/snapshots/${sid}/project`)
                        .then(response => response.json())
                        .then(project => this.setState({project}));
                }
            }

            render(props, { project }) {
                return html`
                    <section class="hero is-primary">
                        <div class="hero-body">
                            <p class="title">${project.name}</p>
                            <p class="subtitle">${project.created_on}</p>
                        </div>
                    </section>
                `;
            }
        }

        function LinkRow({ caption, url, standalone }) {
            return html`
                <a class="panel-block">
                    ${url
                        ? html`<a href="${url}" target="_blank">${caption}</a>`
                        : html`<span>${caption}</span>`
                    }
                    ${standalone && html`<span class="tag is-success ml-2">standalone</span>`}
                </a>
            `;
        }

        function DependencyRow({ entry }) {
            return html`
                <div class="panel-block" style="align-items: baseline">
                    <a class="tags has-addons mb-0" href="${entry.npm_url}" target="_blank">
                      <span class="tag is-dark mb-0">${entry.name}</span>
                      <span class="tag is-info mb-0">${entry.version}</span>
                    </a>
                    <span class="pl-4">
                        ${entry.url
                            ? html`<a href="${entry.url}" target="_blank">${entry.package}</a>`
                            : html`<span>${entry.package}</span>`
                        }
                    </span>
                </div>
            `;
        }

        class ReportPanel extends Component {
            state = {
                activeTab: 0
            };

            setActiveTab(index) {
                this.setState({ activeTab: index });
            }
        }

        class Packages extends ReportPanel {
            state = {
                activeTab: 0,
                warnings: [],
                packages: [],
                dependencies: [],
                devDependencies: []
            };

            componentDidMount() {
                const sid = this.props.sid;
                if (sid) {
                    fetch(`/api/snapshots/${sid}/packages`)
                        .then(response => response.json())
                        .then(packages => this.setState({packages}));

                    fetch(`/api/snapshots/${sid}/warnings`)
                        .then(response => response.json())
                        .then(warnings => this.setState({warnings}));

                    fetch(`/api/snapshots/${sid}/dependencies`)
                        .then(response => response.json())
                        .then(deps => {
                            const dependencies = deps.filter(dep => dep.dev === false)
                            const devDependencies = deps.filter(dep => dep.dev === true)
                            this.setState({dependencies, devDependencies});
                        });
                }
            }

            render(props, { activeTab, warnings, packages, dependencies, devDependencies }) {
                const TabHeader = ({ index, title }) => html`
                    <a class="${ activeTab === index ? 'is-active' : null}" onClick="${() => this.setActiveTab(index)}">${title}</a>
                `;

                return html`
                    <nav class="panel is-link">
                        <p class="panel-heading">Packages (${packages.length})</p>

                        <p class="panel-tabs">
                            <${TabHeader} index=${0} title="Stats"/>
                            ${warnings.length > 0 && html`
                                <${TabHeader} index=${4} title="Warnings (${warnings.length})"/>
                            `}
                            <${TabHeader} index=${1} title="Packages (${packages.length})" />
                            <${TabHeader} index=${2} title="Prod Deps (${dependencies.length})" />
                            <${TabHeader} index=${3} title="Dev Deps (${devDependencies.length})" />
                        </p>

                        <div style="max-height: 500px; overflow-y: scroll">
                            ${activeTab === 0 && html`
                                <${LinkRow} caption="Packages: ${packages.length}"/>
                                <${LinkRow} caption="Product dependencies: ${dependencies.length}"/>
                                <${LinkRow} caption="Development dependencies: ${devDependencies.length}"/>
                            `}

                            ${activeTab === 1 && html`
                                ${packages.map(entry => html`
                                    <${LinkRow} caption="${entry.path}" url="${entry.url}"></LinkRow>
                                `)}
                            `}

                            ${activeTab === 2 && html`
                                ${dependencies.map(entry => html`
                                    <${DependencyRow} entry="${entry}" />
                                `)}
                            `}

                             ${activeTab === 3 && html`
                                ${devDependencies.map(entry => html`
                                    <${DependencyRow} entry="${entry}" />
                                `)}
                            `}

                             ${activeTab === 4 && html`
                                ${warnings.map(entry => html`
                                    <a class="panel-block">
                                        <nav class="breadcrumb">
                                            <ul>
                                                <li>
                                                    ${entry.url
                                                        ? html`<a href="${entry.url}" target="_blank">${entry.path}</a>`
                                                        : html`<span>${entry.path}</span>`
                                                    }
                                                </li>
                                                <li class="is-active">
                                                    <a class="has-text-danger" href="#">${entry.message}</a>
                                                </li>
                                            </ul>
                                        </nav>
                                    </a>
                                `)}
                            `}
                         </div>
                    </nav>
                `;
            }
        }

        class Tests extends ReportPanel {
            state = {
                activeTab: 0,
                unitTests: [],
                e2eTests: [],
                unit_test_cases: 0,
                e2e_test_cases: 0
            };

            setActiveTab(index) {
                super.setActiveTab(index);

                if (index === 0) {
                    setTimeout(() => {
                        this.setupChart();
                    });
                }
            }

            componentDidMount() {
                const sid = this.props.sid;
                if (sid) {
                    fetch(`/api/snapshots/${sid}/unit-tests`)
                        .then(response => response.json())
                        .then(unitTests => {
                            const unit_test_cases = unitTests
                                .map(entry => entry.cases)
                                .reduceRight((acc, cur) => acc + cur, 0);
                            this.setState({unit_test_cases, unitTests});
                        });

                    fetch(`/api/snapshots/${sid}/e2e-tests`)
                        .then(response => response.json())
                        .then(e2eTests => {
                            const e2e_test_cases = e2eTests
                                .map(entry => entry.cases)
                                .reduceRight((acc, cur) => acc + cur, 0);
                            this.setState({e2e_test_cases, e2eTests});
                        });
                }
            }

            setupChart() {
                const ctx = document.getElementById('tests-chart');
                const { unit_test_cases, e2e_test_cases } = this.state;

                const existing = Chart.getChart('tests-chart');
                if (existing) {
                    existing.destroy();
                }

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Unit Cases', 'E2E Cases'],
                        datasets: [{
                            label: '# of cases',
                            data: [
                                unit_test_cases,
                                e2e_test_cases,
                            ],
                            backgroundColor: [
                                'rgb(255, 99, 132)',
                                'rgb(54, 162, 235)'
                            ],
                            hoverOffset: 4
                        }]
                    }
                });
            }

            render(props, { activeTab,  unit_test_cases, e2e_test_cases, unitTests, e2eTests }) {
                setTimeout(() => {
                    if (activeTab === 0) {
                        this.setupChart();
                    }
                });

                const TabHeader = ({ index, title }) => html`
                    <a class="${ activeTab === index ? 'is-active' : null}" onClick="${() => this.setActiveTab(index)}">${title}</a>
                `;

                return html`
                    <nav class="panel is-link">
                        <p class="panel-heading">Tests (${ unit_test_cases + e2e_test_cases})</p>

                        <p class="panel-tabs">
                            <${TabHeader} index=${0} title="Stats" />
                            ${unitTests.length > 0 && html`<${TabHeader} index=${1} title="Unit Tests (${unitTests.length})" />`}
                            ${e2eTests.length > 0 && html`<${TabHeader} index=${2} title="E2E Tests (${e2eTests.length})" />`}
                        </p>

                        <div style="max-height: 500px; overflow-y: scroll">
                            ${activeTab === 0 && html`
                                <div style="max-height: 400px; padding: 12px">
                                  <canvas id="tests-chart"></canvas>
                                </div>
                            `}

                            ${activeTab === 1 && html`
                                ${unitTests.map(entry => html`
                                    <${LinkRow} caption="${entry.path} (${entry.cases} cases)" url="${entry.url}"></LinkRow>
                                `)}
                            `}

                            ${activeTab === 2 && html`
                                ${e2eTests.map(entry => html`
                                    <${LinkRow} caption="${entry.path} (${entry.cases} cases)" url="${entry.url}"></LinkRow>
                                `)}
                            `}
                        </div>
                    </nav>
                `;
            }
        }

        class Angular extends ReportPanel {
            state = {
                version: '',
                activeTab: 0,
                modules: [],
                components: [],
                directives: [],
                services: [],
                pipes: [],
                dialogs: []
            };
            setActiveTab(index) {
                super.setActiveTab(index);

                if (index === 0) {
                    setTimeout(() => { this.setupChart();});
                }
            }

            componentDidMount() {
                const sid = this.props.sid;
                if (sid) {
                    fetch(`/api/snapshots/${sid}/angular`)
                        .then(response => response.json())
                        .then(angular => this.setState({...angular}));
                }
            }

            setupChart() {
                const ctx = document.getElementById('angular-chart');

                const existing = Chart.getChart('angular-chart');
                if (existing) {
                    existing.destroy();
                }

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Module', 'Component', 'Directive', 'Service', 'Pipe', 'Dialog'],
                        datasets: [{
                            label: '# of elements',
                            data: [
                                this.state.modules.length,
                                this.state.components.length,
                                this.state.directives.length,
                                this.state.services.length,
                                this.state.pipes.length,
                                this.state.dialogs.length
                            ],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(255, 159, 64, 0.2)',
                                // 'rgba(255, 205, 86, 0.2)',
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(153, 102, 255, 0.2)',
                                'rgba(201, 203, 207, 0.2)'
                            ],
                            borderColor: [
                                'rgb(255, 99, 132)',
                                'rgb(255, 159, 64)',
                                // 'rgb(255, 205, 86)',
                                'rgb(75, 192, 192)',
                                'rgb(54, 162, 235)',
                                'rgb(153, 102, 255)',
                                'rgb(201, 203, 207)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            render(props, { activeTab, modules, components, directives, services, pipes, dialogs, version }) {
                setTimeout(() => {
                    if (activeTab === 0) {
                        this.setupChart();
                    }
                });
                const TabHeader = ({ index, title }) => html`
                    <a class="${ activeTab === index ? 'is-active' : null}" onClick="${() => this.setActiveTab(index)}">${title}</a>
                `;

                return html`
                    <nav class="panel is-link">
                        <p class="panel-heading">Angular (${version})</p>

                        <p class="panel-tabs">
                            <${TabHeader} index=${0} title="Stats" />

                            ${modules.length > 0 && html`<${TabHeader} index=${1} title="Modules (${modules.length})" />`}
                            ${components.length > 0 && html`<${TabHeader} index=${2} title="Components (${components.length})" />`}
                            ${directives.length > 0 && html`<${TabHeader} index=${3} title="Directives (${directives.length})" />`}
                            ${services.length > 0 && html`<${TabHeader} index=${4} title="Services (${services.length})" />`}
                            ${pipes.length > 0 && html`<${TabHeader} index=${5} title="Pipes (${pipes.length})" />`}
                            ${dialogs.length > 0 && html`<${TabHeader} index=${6} title="Dialogs (${dialogs.length})" />`}
                        </p>

                        <div style="max-height: 500px; overflow-y: scroll">
                            ${activeTab === 0 && html`
                                <div style="max-height: 400px; padding: 12px">
                                  <canvas id="angular-chart"></canvas>
                                </div>
                            `}

                            ${activeTab === 1 && html`
                                ${modules.map(entry => html`
                                    <${LinkRow} caption="${entry.path}" url="${entry.url}"/>
                                `)}
                            `}

                            ${activeTab === 2 && html`
                                ${components.map(entry => html`
                                    <${LinkRow} caption="${entry.path}" url="${entry.url}" standalone="${entry.standalone}"/>
                                `)}
                            `}

                            ${activeTab === 3 && html`
                                ${directives.map(entry => html`
                                    <${LinkRow} caption="${entry.path}" url="${entry.url}" standalone="${entry.standalone}"/>
                                `)}
                            `}

                            ${activeTab === 4 && html`
                                ${services.map(entry => html`
                                    <${LinkRow} caption="${entry.path}" url="${entry.url}"/>
                                `)}
                            `}

                            ${activeTab === 5 && html`
                                ${pipes.map(entry => html`
                                    <${LinkRow} caption="${entry.path}" url="${entry.url}" standalone="${entry.standalone}"/>
                                `)}
                            `}

                            ${activeTab === 6 && html`
                                ${dialogs.map(entry => html`
                                    <${LinkRow} caption="${entry.path}" url="${entry.url}" standalone="${entry.standalone}"/>
                                `)}
                            `}
                        </div>
                    </nav>
                `;
            }
        }

        class GitReport extends ReportPanel {
            state = {
                project: {},
                activeTab: 0,
                authors: []
            };
            setActiveTab(index) {
                super.setActiveTab(index);

                if (index === 1) {
                    setTimeout(() => {
                        this.setupChart();
                    });
                }
            }

            setupChart() {
                const ctx = document.getElementById('git-top-contributors');
                const authors = (this.state.authors || []).slice(0, 20);

                const existing = Chart.getChart('git-top-contributors');
                if (existing) {
                    existing.destroy();
                }

                const chart_labels = authors.map(entry => entry.name);
                const chart_data = authors.map(entry => entry.commits);

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chart_labels,
                        datasets: [{
                            label: '# of commits',
                            data: chart_data,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            componentDidMount() {
                const sid = this.props.sid;
                if (sid) {
                    fetch(`/api/snapshots/${sid}/project`)
                        .then(response => response.json())
                        .then(project => this.setState({project}));

                    fetch(`/api/snapshots/${sid}/authors`)
                        .then(response => response.json())
                        .then(authors => this.setState({authors}));
                }
            }

            render(props, { activeTab, project, authors }) {
                setTimeout(() => {
                    if (activeTab === 1) {
                        this.setupChart();
                    }
                });

                const TabHeader = ({ index, title }) => html`
                    <a class="${ activeTab === index ? 'is-active' : null}" onClick="${() => this.setActiveTab(index)}">${title}</a>
                `;

                return html`
                    <nav class="panel is-link">
                        <p class="panel-heading">Git</p>

                        <p class="panel-tabs">
                            <${TabHeader} index=${0} title="Stats" />
                            <${TabHeader} index=${1} title="Top Contributors" />
                            <${TabHeader} index=${2} title="All Authors" />
                        </p>

                        <div style="max-height: 500px; overflow-y: scroll">
                            ${activeTab === 0 && html`
                                <${LinkRow} caption="Remote: ${project.origin}" url="${project.origin}"/>
                                <${LinkRow} caption="Tag: ${project.tag}"/>
                                <${LinkRow} caption="Timestamp: ${project.timestamp}"/>
                            `}
                            ${activeTab === 1 && html`
                                <div style="max-height: 400px; padding: 12px">
                                  <canvas id="git-top-contributors"></canvas>
                                </div>
                            `}
                            ${activeTab === 2 && html`
                                ${authors.map(author => html`
                                    <${LinkRow} caption="${author.name} (${author.commits} commits)"/>
                                `)}
                            `}
                        </div>
                    </nav>
                `;
            }
        }

        class FileTypes extends Component {
            state = {
                rows: []
            };
            componentDidMount() {
                const sid = this.props.sid;
                if (sid) {
                    fetch(`/api/snapshots/${sid}/file-types`)
                        .then(response => response.json())
                        .then(types => {
                            const rows = Object.keys(types)
                                .map(key => ({key, value: types[key]}))
                                .sort((a, b) => b.value - a.value);
                            this.setState({rows});
                        });
                }
            }

            render(props, { rows }) {
                return html`
                    <nav class="panel is-link">
                        <p class="panel-heading">File Types</p>

                        <div style="max-height: 500px; overflow-y: scroll">
                            ${rows.map(row => html`
                                <${LinkRow} caption="${row.key}: ${row.value}"/>
                            `)}
                        </div>
                    </nav>
                `;
            }
        }

        class ProjectList extends Component {
            state = {
                rows: []
            };
            componentDidMount() {
                fetch(`/api/projects`)
                    .then(response => response.json())
                    .then(rows => this.setState({rows}));
            }

            render(props, { rows }) {
                return html`
                    <nav class="panel is-link">
                        <p class="panel-heading">Projects</p>

                        <div style="max-height: 500px; overflow-y: scroll">
                            ${rows.map(row => html`
                                <${LinkRow} caption="${row.name}"/>
                            `)}
                        </div>
                    </nav>
                `;
            }
        }

        function App() {
            const sid = window.snapshotId;
            const hasSnapshot = !!sid;

            return html`
                <main>
                    <${Header} sid=${sid}></Header>
                    <section class="section">
                        <${ProjectList}/>
                        <${GitReport} sid=${sid}/>
                        <${Packages} sid=${sid}/>
                        <${Angular} sid=${sid}/>
                        <${Tests} sid=${sid}/>
                        <${FileTypes} sid=${sid}/>
                    </section>
                </main>
            `;
        }

        render(html`
            <${App}/>`, document.body);
    </script>
    <script>
        window.addEventListener("DOMContentLoaded", (event) => {
            // on load handlers
        });
    </script>
</head>
<body></body>
</html>
